#!/bin/bash

# CVE Query Runner Script
# Runs all jq queries from the jq_queries directory against cve.json

set -e

CVE_FILE="cve.json"
QUERIES_DIR="jq_queries"

# Check if cve.json exists
if [[ ! -f "$CVE_FILE" ]]; then
    echo "Error: $CVE_FILE not found in current directory"
    exit 1
fi

# Check if queries directory exists
if [[ ! -d "$QUERIES_DIR" ]]; then
    echo "Error: $QUERIES_DIR directory not found"
    exit 1
fi

echo "Running CVE queries against $CVE_FILE"
echo "========================================"

# Function to run a query with proper error handling
run_query() {
    local query_file="$1"
    local query_name=$(basename "$query_file" .jq)
    local extra_flags="$2"
    
    echo
    echo "--- $query_name ---"
    
    if jq -r $extra_flags -f "$query_file" "$CVE_FILE" 2>/dev/null; then
        echo "✅ Query completed successfully"
    else
        echo "❌ Query failed or returned no results"
    fi
}

# Run basic queries first
echo "=== BASIC LOOKUPS ==="
run_query "$QUERIES_DIR/get_all_cve_ids.jq"
run_query "$QUERIES_DIR/get_cves_by_severity.jq"
run_query "$QUERIES_DIR/get_cve_details.jq"

echo
echo "=== INDEX-BASED QUERIES ==="
run_query "$QUERIES_DIR/cves_by_release.jq"
run_query "$QUERIES_DIR/releases_by_cve.jq"
run_query "$QUERIES_DIR/cves_by_product.jq"

echo
echo "=== COMPONENT ANALYSIS ==="
run_query "$QUERIES_DIR/get_all_affected_products.jq"
run_query "$QUERIES_DIR/get_fixed_versions_products.jq"
run_query "$QUERIES_DIR/get_fixed_versions_extensions.jq"

echo
echo "=== COMMIT ANALYSIS ==="
run_query "$QUERIES_DIR/get_commits_for_cve.jq"
run_query "$QUERIES_DIR/get_commits_for_release.jq"
run_query "$QUERIES_DIR/repository_commit_summary.jq"

echo
echo "=== RISK ASSESSMENT ==="
run_query "$QUERIES_DIR/cves_with_release_impact.jq"
run_query "$QUERIES_DIR/components_with_multiple_vulnerabilities.jq"
run_query "$QUERIES_DIR/cross_component_impact_analysis.jq"

echo
echo "=== TEMPORAL ANALYSIS ==="
run_query "$QUERIES_DIR/age_of_vulnerabilities.jq"

echo
echo "=== VERSION VULNERABILITY ASSESSMENT ==="
run_query "$QUERIES_DIR/check_version_vulnerable.jq"

echo
echo "=== PLATFORM-SPECIFIC ANALYSIS ==="
run_query "$QUERIES_DIR/cves_by_platform.jq"

echo
echo "=== ADVANCED QUERIES ==="
run_query "$QUERIES_DIR/extensions_requiring_immediate_attention.jq"
run_query "$QUERIES_DIR/patch_deployment_summary.jq"
run_query "$QUERIES_DIR/release_independent_extensions.jq"

echo
echo "=== EMERGENCY RESPONSE QUERIES ==="
run_query "$QUERIES_DIR/immediate_risk_assessment.jq"
run_query "$QUERIES_DIR/most_vulnerable_component.jq"

echo
echo "=== REPORTING AND DISPLAY ==="
run_query "$QUERIES_DIR/cve_report_with_display_names.jq"
run_query "$QUERIES_DIR/product_report_with_names.jq"
run_query "$QUERIES_DIR/security_advisory_full_taxonomy.jq"

echo
echo "=== ERROR HANDLING & VALIDATION ==="
run_query "$QUERIES_DIR/defensive_cve_lookup.jq"
run_query "$QUERIES_DIR/safe_version_queries.jq"
run_query "$QUERIES_DIR/validate_severity_mappings.jq"
run_query "$QUERIES_DIR/validate_product_mappings.jq"
run_query "$QUERIES_DIR/validate_platform_mappings.jq"


echo
echo "========================================"
echo "All queries completed!"

# Summary information
total_queries=$(find "$QUERIES_DIR" -name "*.jq" | wc -l)
echo "Total queries available: $total_queries"